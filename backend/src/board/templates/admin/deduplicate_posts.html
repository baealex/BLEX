{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div id="content-main">
    <div class="breadcrumbs">
        <a href="{% url 'admin:utility_dashboard' %}">ìœ í‹¸ë¦¬í‹° ê´€ë¦¬</a> &rsaquo; ì¤‘ë³µ í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ì œê±°
    </div>
    
    <h1>ğŸ”„ ì¤‘ë³µ í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ì œê±°</h1>
    
    {% if not result %}
    <form method="post" class="module aligned">
        {% csrf_token %}
        
        <div class="help">
            <h3>â„¹ï¸ ì¤‘ë³µ ì œê±° ì•ˆë‚´</h3>
            <p>ë™ì¼í•œ ë‚´ìš©ì˜ í¬ìŠ¤íŠ¸ íƒ€ì´í‹€ ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ í•˜ë‚˜ì˜ ë§ˆìŠ¤í„° ì´ë¯¸ì§€ë¡œ í†µí•©í•˜ê³  ì¤‘ë³µ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤.</p>
            <ul>
                <li>íŒŒì¼ í•´ì‹œ(SHA-256)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ê²€ì‚¬</li>
                <li>ê°€ì¥ ì§§ì€ ê²½ë¡œë¥¼ ë§ˆìŠ¤í„°ë¡œ ì„ íƒ</li>
                <li>ì¤‘ë³µ íŒŒì¼ ì‚¬ìš© ì¤‘ì¸ í¬ìŠ¤íŠ¸ëŠ” ë§ˆìŠ¤í„° ì´ë¯¸ì§€ë¡œ ìë™ ì—…ë°ì´íŠ¸</li>
                <li>íŒŒìƒ íŒŒì¼(.preview, .minify)ë„ í•¨ê»˜ ì‚­ì œ</li>
            </ul>
            <p><strong>âš ï¸ Dry-run ëª¨ë“œ</strong>ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì¤‘ë³µ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <div class="submit-row" style="display: flex; gap: 10px;">
            <button type="submit" name="execute" value="false" class="default">Dry-run (ë¯¸ë¦¬ë³´ê¸°)</button>
            <button type="submit" name="execute" value="true" class="button" 
                    onclick="return confirm('ì •ë§ë¡œ ì¤‘ë³µ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                ì‹¤í–‰ (ì¤‘ë³µ ì œê±°)
            </button>
        </div>
    </form>
    {% else %}
    <div class="module">
        <h2>ì‹¤í–‰ ê²°ê³¼</h2>
        
        {% for msg_type, message in result.messages %}
        <p class="
            {% if msg_type == 'success' %}success
            {% elif msg_type == 'error' %}errornote
            {% elif msg_type == 'warning' %}warning
            {% else %}help{% endif %}">
            {{ message }}
        </p>
        {% endfor %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600;">{{ result.statistics.total_posts }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">ì „ì²´ í¬ìŠ¤íŠ¸ ìˆ˜</div>
            </div>
            
            {% if result.statistics.duplicates_count is not None and result.statistics.duplicates_count > 0 %}
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600; color: var(--error-fg);">{{ result.statistics.duplicates_count }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">
                    {% if request.POST.execute == 'true' %}ì‚­ì œëœ ì¤‘ë³µ íŒŒì¼{% else %}ì¤‘ë³µ íŒŒì¼ ë°œê²¬{% endif %}
                </div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600; color: var(--button-bg);">{{ result.statistics.space_saved_mb }} MB</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">
                    {% if request.POST.execute == 'true' %}ì ˆì•½ëœ ê³µê°„{% else %}ì ˆì•½ ê°€ëŠ¥{% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        {% if result.statistics.duplicate_groups %}
        <h3>ì¤‘ë³µ ê·¸ë£¹ ëª©ë¡</h3>
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--hairline-color); border-radius: 4px; padding: 15px;">
            {% for group in result.statistics.duplicate_groups %}
            <div style="margin-bottom: 20px; padding: 15px; background: var(--darkened-bg); border-radius: 4px;">
                <div style="font-weight: 600; margin-bottom: 10px;">
                    ì¤‘ë³µ ê·¸ë£¹ #{{ forloop.counter }} (í•´ì‹œ: {{ group.hash }}...)
                    <span style="color: var(--error-fg); margin-left: 10px;">{{ group.count }}ê°œ ì¤‘ë³µ</span>
                </div>
                <div style="margin-left: 15px;">
                    <div style="margin-bottom: 8px;">
                        <span style="color: var(--button-bg); font-weight: 600;">âœ“ ë§ˆìŠ¤í„°:</span>
                        <code>{{ group.master }}</code>
                    </div>
                    {% for path in group.redundant %}
                    <div style="margin-bottom: 5px; opacity: 0.8;">
                        <span style="color: var(--error-fg);">âœ— ì¤‘ë³µ:</span>
                        <code>{{ path }}</code>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="submit-row">
            <a href="{% url 'admin:deduplicate_posts' %}" class="button">ë‹¤ì‹œ ì‹¤í–‰</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
