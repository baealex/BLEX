{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div id="content-main">
    <div class="breadcrumbs">
        <a href="{% url 'admin:utility_dashboard' %}">ìœ í‹¸ë¦¬í‹° ê´€ë¦¬</a> &rsaquo; HTML íƒœê·¸ ê²€ì¦
    </div>
    
    <h1>ğŸ” HTML íƒœê·¸ ê²€ì¦</h1>
    
    {% if not result %}
    <form method="post" class="module aligned">
        {% csrf_token %}
        
        <div class="help">
            <h3>â„¹ï¸ í—¤ë”© íƒœê·¸ ê²€ì¦ ì•ˆë‚´</h3>
            <p>í¬ìŠ¤íŠ¸ì˜ text_htmlì—ì„œ ì˜ëª» ë§¤ì¹­ëœ í—¤ë”© íƒœê·¸(h1~h6)ë¥¼ ì°¾ì•„ì„œ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
            <ul>
                <li>íƒœê·¸ ë¶ˆì¼ì¹˜: <code>&lt;h2&gt;</code>ë¡œ ì—´ê³  <code>&lt;/h1&gt;</code>ë¡œ ë‹«ëŠ” ê²½ìš°</li>
                <li>ë‹«íˆì§€ ì•Šì€ íƒœê·¸: ì—¬ëŠ” íƒœê·¸ë§Œ ìˆê³  ë‹«ëŠ” íƒœê·¸ê°€ ì—†ëŠ” ê²½ìš°</li>
                <li>ì¶”ê°€ ë‹«ëŠ” íƒœê·¸: ì—¬ëŠ” íƒœê·¸ ì—†ì´ ë‹«ëŠ” íƒœê·¸ë§Œ ìˆëŠ” ê²½ìš°</li>
            </ul>
            <p><strong>âš ï¸ ìˆ˜ì • ë°©ì‹:</strong> íƒœê·¸ ë¶ˆì¼ì¹˜ëŠ” ë‹«ëŠ” íƒœê·¸ë¥¼ ì—¬ëŠ” íƒœê·¸ì™€ ë§ì¶°ì„œ ìë™ ìˆ˜ì •í•©ë‹ˆë‹¤. (ì˜ˆ: <code>&lt;h2&gt;...&lt;/h1&gt;</code> â†’ <code>&lt;h2&gt;...&lt;/h2&gt;</code>)</p>
            <p><strong>â„¹ï¸ ê²€ì‚¬ ë²”ìœ„:</strong> h1, h2, h3, h4, h5, h6 íƒœê·¸ë§Œ ê²€ì‚¬í•©ë‹ˆë‹¤.</p>
            <p><strong>âš ï¸ Dry-run ëª¨ë“œ</strong>ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ë¬¸ì œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <div class="submit-row" style="display: flex; gap: 10px;">
            <button type="submit" name="execute" value="false" class="default">Dry-run (ê²€ì‚¬)</button>
            <button type="submit" name="execute" value="true" class="button" 
                    onclick="return confirm('ì •ë§ë¡œ HTML íƒœê·¸ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                ì‹¤í–‰ (ìˆ˜ì •)
            </button>
        </div>
    </form>
    {% else %}
    <div class="module">
        <h2>ì‹¤í–‰ ê²°ê³¼</h2>
        
        {% for msg_type, message in result.messages %}
        <p class="
            {% if msg_type == 'success' %}success
            {% elif msg_type == 'error' %}errornote
            {% elif msg_type == 'warning' %}warning
            {% else %}help{% endif %}">
            {{ message }}
        </p>
        {% endfor %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600;">{{ result.statistics.total_posts }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">ì „ì²´ í¬ìŠ¤íŠ¸ ìˆ˜</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600; color: var(--error-fg);">{{ result.statistics.posts_with_issues }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">ë¬¸ì œ ìˆëŠ” í¬ìŠ¤íŠ¸</div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600; color: var(--error-fg);">{{ result.statistics.total_issues }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">ì´ ë¬¸ì œ ìˆ˜</div>
            </div>
            
            {% if result.statistics.fixed_count > 0 %}
            <div style="text-align: center; padding: 20px; background: var(--body-bg); border: 1px solid var(--hairline-color); border-radius: 4px;">
                <div style="font-size: 36px; font-weight: 600; color: var(--button-bg);">{{ result.statistics.fixed_count }}</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">ìˆ˜ì •ëœ í¬ìŠ¤íŠ¸</div>
            </div>
            {% endif %}
        </div>
        
        {% if result.statistics.issue_details %}
        <h3>ë¬¸ì œ ìƒì„¸ (ìµœëŒ€ 20ê°œ)</h3>
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--hairline-color); border-radius: 4px; padding: 15px;">
            {% for post_info in result.statistics.issue_details %}
            <div style="margin-bottom: 20px; padding: 15px; background: var(--darkened-bg); border-radius: 4px;">
                <div style="font-weight: 600; margin-bottom: 10px;">
                    í¬ìŠ¤íŠ¸ #{{ post_info.id }}: {{ post_info.title }}
                    <span style="color: var(--error-fg); margin-left: 10px;">{{ post_info.issues|length }}ê°œ ë¬¸ì œ</span>
                </div>
                <div style="margin-left: 15px;">
                    {% for issue in post_info.issues %}
                    <div style="margin-bottom: 10px; padding: 10px; background: var(--body-bg); border-radius: 4px;">
                        {% if issue.type == 'mismatch' %}
                        <div style="color: var(--error-fg); font-weight: 600;">âš ï¸ íƒœê·¸ ë¶ˆì¼ì¹˜</div>
                        <div style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                            ì—¬ëŠ” íƒœê·¸: <code>{{ issue.opening_text }}</code> (ìœ„ì¹˜: {{ issue.opening_position }})
                        </div>
                        <div style="font-family: monospace; font-size: 12px;">
                            ë‹«ëŠ” íƒœê·¸: <code>{{ issue.closing_text }}</code> (ìœ„ì¹˜: {{ issue.closing_position }})
                        </div>
                        <div style="margin-top: 5px; color: var(--button-bg);">
                            â†’ ìˆ˜ì •: <code>&lt;/{{ issue.opening_tag }}&gt;</code>ë¡œ ë³€ê²½
                        </div>
                        {% elif issue.type == 'unclosed' %}
                        <div style="color: var(--error-fg); font-weight: 600;">âš ï¸ ë‹«íˆì§€ ì•Šì€ íƒœê·¸</div>
                        <div style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                            íƒœê·¸: <code>{{ issue.text }}</code> (ìœ„ì¹˜: {{ issue.position }})
                        </div>
                        {% elif issue.type == 'extra_closing' %}
                        <div style="color: var(--error-fg); font-weight: 600;">âš ï¸ ì¶”ê°€ ë‹«ëŠ” íƒœê·¸</div>
                        <div style="margin-top: 5px; font-family: monospace; font-size: 12px;">
                            íƒœê·¸: <code>{{ issue.text }}</code> (ìœ„ì¹˜: {{ issue.position }})
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="submit-row">
            <a href="{% url 'admin:validate_html' %}" class="button">ë‹¤ì‹œ ì‹¤í–‰</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
