{% extends 'board/base.html' %}
{% load static %}
{% load island %}

{% block title %}Edit About {{ author.username }} - BLEX{% endblock %}

{% block content %}
{% include 'board/author/components/author_header.html' %}

<div class="max-w-5xl w-full mx-auto px-4 sm:px-6">
    {% with active_tab='about' %}
        {% include 'board/author/components/tabs_nav.html' %}
    {% endwith %}

    <div class="mb-8">
        <div class="mb-6">
            <h1 class="text-lg font-bold mb-3 text-gray-800">자신을 소개해 보세요.</h1>
            <p class="text-md text-gray-600">자신을 소개하는 글을 작성해 보세요.</p>
        </div>

        <div class="mb-6"
             x-data="{
                content: '{{ about_md|escapejs }}',
                username: '{{ author.username }}',
                redirectPath: '/@{{ author.username }}/about',
                placeholder: '마크다운으로 작성해 보세요.',
                isSaving: false,
                message: '',
                isSuccess: false,
                init() {
                    const data = JSON.parse(this.$refs.formData.textContent);
                    this.content = data.initialValue;
                    this.username = data.username;
                    this.redirectPath = data.redirectPath;
                },
                async saveAbout() {
                    this.isSaving = true;
                    this.message = '';
                    this.isSuccess = false;
        
                    try {
                        const formData = new FormData();
                        formData.append('about_md', this.content);
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                        const response = await fetch(`/@${this.username}/about/edit`, {
                            method: 'POST',
                            body: formData
                        });
        
                        if (response.ok) {
                            this.message = '소개가 업데이트되었습니다.';
                            this.isSuccess = true;
                            window.location.replace(this.redirectPath);
                        } else {
                            const errorData = await response.json();
                            this.message = errorData.detail || '저장 실패: 알 수 없는 오류가 발생했습니다.';
                            this.isSuccess = false;
                        }
                    } catch (error) {
                        this.message = '네트워크 오류: ' + error.message;
                        this.isSuccess = false;
                    } finally {
                        this.isSaving = false;
                    }
                }
            }">
            <textarea
                x-model="content"
                :placeholder="placeholder"
                class="w-full p-4 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-64"
            ></textarea>
            <button
                @click="saveAbout()"
                :disabled="isSaving"
                class="mt-4 px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50"
            >
                <span x-show="!isSaving">저장</span>
                <span x-show="isSaving">저장 중...</span>
            </button>

            <div x-show="message" :class="isSuccess ? 'text-gray-700' : 'text-gray-900'" class="mt-4 text-sm">
                <span x-text="message"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
