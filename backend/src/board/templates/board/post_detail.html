{% extends 'board/base.html' %}
{% load static %}
{% load island %}

{% block title %}{{ post.title }} - {{ post.author_username }} | BLEX{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% island_css 'post' %}">
<style>
    /* Post detail styles */
    .post-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 0;
    }

    /* Post header */
    .post-header {
        margin-bottom: 32px;
    }

    .post-title {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 16px;
        line-height: 1.2;
    }

    .post-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 24px;
    }

    .post-author {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .post-author-image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .post-author-name {
        font-weight: 600;
        color: #333;
    }

    .post-date {
        color: #666;
        font-size: 14px;
    }

    .post-read-time {
        color: #666;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Post cover image */
    .post-cover-container {
        padding-top: 24px;
        margin-bottom: 32px;
    }

    .post-cover-image {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Post tags */
    .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 32px;
        margin-bottom: 32px;
    }

    .post-tag {
        display: inline-block;
        padding: 6px 12px;
        background-color: #f0f0f0;
        color: #555;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .post-tag:hover {
        background-color: #e0e0e0;
        color: #333;
    }

    /* Post actions */
    .post-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .post-action-group {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .post-share-button {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.2s ease;
    }

    .post-share-button:hover {
        background-color: #f0f0f0;
    }

    /* Series info */
    .series-info {
        margin-top: 40px;
        margin-bottom: 40px;
        padding: 24px;
        background-color: #f9f9f9;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .series-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .series-title {
        font-size: 20px;
        font-weight: 700;
    }

    .series-title a {
        color: #333;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .series-title a:hover {
        color: #4568dc;
    }

    .series-progress {
        font-size: 14px;
        color: #666;
        background-color: #eee;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .series-posts {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    .series-post-item {
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .series-post-item:last-child {
        border-bottom: none;
    }

    .series-post-link {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #333;
        font-weight: 500;
        transition: color 0.2s ease;
        text-decoration: none;
    }

    .series-post-link:hover {
        color: #4568dc;
    }
    
    .series-post-link.active {
        color: #4568dc;
        font-weight: 700;
    }
    
    .series-post-number {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        background-color: #eee;
        border-radius: 50%;
        font-size: 14px;
        font-weight: 600;
    }
    
    .series-post-link.active .series-post-number {
        background-color: #4568dc;
        color: white;
    }
    
    .series-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e0e0e0;
    }
    
    .series-nav-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background-color: #f0f0f0;
        border-radius: 6px;
        color: #555;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .series-nav-button:hover {
        background-color: #e0e0e0;
        color: #333;
    }
    
    .series-nav-button.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .series-post-link.active .series-post-number {
        background-color: #4568dc;
        color: white;
    }

    /* Comments section */
    .comments-section {
        margin-top: 60px;
    }

    .comments-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 24px;
    }

    /* Related posts */
    .related-posts {
        margin-top: 60px;
    }

    .related-posts-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 24px;
    }

    .related-posts-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 24px;
    }

    @media (min-width: 768px) {
        .related-posts-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .related-posts-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* White theme only - dark mode removed */
</style>
{% endblock %}

{% block content %}
<div class="post-container">
    <article class="post-article">
        <header class="post-header">
            <h1 class="post-title">{{ post.title }}</h1>
            <div class="post-meta">
                <div class="post-author">
                    <a href="/@{{ post.author_username }}">
                        <img class="post-author-image" src="{% if post.author_image %}{% static post.author_image %}{% else %}{% static 'default_avatar.jpg' %}{% endif %}" alt="{{ post.author_username }}">
                    </a>
                    <a href="/@{{ post.author_username }}" class="post-author-name">
                        {{ post.author_username }}
                    </a>
                </div>
                <div class="post-date">{{ post.created_date }}</div>
                <div class="post-read-time">
                    <i class="far fa-clock"></i>
                    <span>{{ post.read_time }}분 분량</span>
                </div>
            </div>

            {% if post.image %}
            <div class="post-cover-container">
                <img class="post-cover-image" src="{% static post.image.url %}" alt="{{ post.title }}">
            </div>
            {% endif %}
        </header>

        <div class="blog-post-content">
            {{ post.content.text_html|safe }}
        </div>

        {% if post.tags %}
        <div class="post-tags">
            {% for tag in post.tags.all %}
                <a href="{% url 'tag_detail' tag %}" class="post-tag">{{ tag }}</a>
            {% endfor %}
        </div>
        {% endif %}

        <div class="post-actions">
            <div class="post-action-group">
                {% island_component 'LikeButton' postId=post.url likesCount=post.count_likes hasLiked=post.has_liked size='large' %}
                <button class="post-share-button" id="shareButton">
                    <i class="fas fa-share-alt"></i>
                    <span>Share</span>
                </button>
            </div>

            {% if user.is_authenticated and user.username == post.author_username %}
            <div class="post-action-group">
                <a href="{% url 'post_edit' post.author_username post.url %}" class="btn btn-outline-primary">
                    <i class="fas fa-edit"></i>
                    <span>Edit</span>
                </a>
            </div>
            {% endif %}
        </div>
    </article>

    {% if post.series %}
    <div class="series-info">
        <div class="series-header">
            <h3 class="series-title">
                <a href="{% url 'series_detail' post.author_username post.series.url %}">{{ post.series.name }}</a>
            </h3>
            <div class="series-progress">
                {{ post.series_index }} / {{ post.series_total }} 포스트
            </div>
        </div>
        <ul class="series-posts">
            {% for series_post in post.visible_series_posts %}
                <li class="series-post-item">
                    <a href="{% url 'post_detail' post.author_username series_post.url %}"
                        class="series-post-link {% if series_post.url == post.url %}active{% endif %}">
                        <span class="series-post-number">{{ series_post.series_index }}</span>
                        <span>{{ series_post.title }}</span>
                    </a>
                </li>
            {% endfor %}
        </ul>
        
        {% if post.series_total > 1 %}
        <div class="series-navigation">
            {% if post.prev_post %}
                <a href="{% url 'post_detail' post.author_username post.prev_post.url %}" class="series-nav-button">
                    <i class="fas fa-chevron-left"></i> 이전 포스트
                </a>
            {% else %}
                <span class="series-nav-button disabled">
                    <i class="fas fa-chevron-left"></i> 이전 포스트
                </span>
            {% endif %}
            
            <a href="{% url 'series_detail' post.author_username post.series.url %}" class="series-nav-button">
                <i class="fas fa-th-list"></i> 전체 시리즈
            </a>
            
            {% if post.next_post %}
                <a href="{% url 'post_detail' post.author_username post.next_post.url %}" class="series-nav-button">
                    다음 포스트 <i class="fas fa-chevron-right"></i>
                </a>
            {% else %}
                <span class="series-nav-button disabled">
                    다음 포스트 <i class="fas fa-chevron-right"></i>
                </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="comments-section">
        <h3 class="comments-title">댓글 {{ post.count_comments }}개</h3>
        {% island_component 'Comments' postUrl=post.url %}
    </div>

    {% if related_posts %}
    <div class="related-posts">
        <h3 class="related-posts-title">관련 포스트</h3>
        <div class="related-posts-grid">
            {% for related_post in related_posts %}
            <div class="post-card">
                {% if related_post.image %}
                <div class="post-image-container">
                    <img class="post-image" src="{{ related_post.image.url }}" alt="{{ related_post.title }}">
                </div>
                {% endif %}
                <div class="post-content">
                    <h3 class="post-title">
                        <a href="{% url 'post_detail' related_post.author_username related_post.url %}">{{ related_post.title}}</a>
                    </h3>
                    <p class="post-description">{{ related_post.meta_description }}</p>
                    <div class="post-meta">
                        {{ related_post.created_date }} · {{ related_post.read_time }}분 분량
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Share functionality
    document.addEventListener('DOMContentLoaded', function () {
        const shareButton = document.getElementById('shareButton');
        if (shareButton) {
            shareButton.addEventListener('click', function () {
                if (navigator.share) {
                    navigator.share({
                        title: '{{ post.title }}',
                        text: '{{ post.meta_description }}',
                        url: window.location.href
                    })
                        .catch(error => console.log('Error sharing:', error));
                } else {
                    // Fallback for browsers that don't support the Web Share API
                    const tempInput = document.createElement('input');
                    tempInput.value = window.location.href;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);

                    // Show a temporary message
                    const shareText = shareButton.querySelector('span');
                    const originalText = shareText.textContent;
                    shareText.textContent = 'Copied!';
                    setTimeout(() => {
                        shareText.textContent = originalText;
                    }, 2000);
                }
            });
        }
    });
</script>
{% endblock %}
