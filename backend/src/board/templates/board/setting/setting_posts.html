{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}포스트 설정{% endblock %}

{% block setting_content %}
{% csrf_token %}
<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-4 mb-2">
        <select class="form-control" id="order-select">
            <option value="-created_date">작성일 (최신부터)</option>
            <option value="created_date">작성일 (과거부터)</option>
            <option value="title">제목 (ㄱ-ㅎ)</option>
            <option value="-title">제목 (ㅎ-ㄱ)</option>
            <option value="-updated_date">수정일 (최신부터)</option>
            <option value="updated_date">수정일 (과거부터)</option>
            <option value="-count_likes">추천 많은 순</option>
            <option value="count_likes">추천 적은 순</option>
            <option value="-read_time">분량 많은 순</option>
            <option value="read_time">분량 적은 순</option>
            <option value="-count_comments">댓글 많은 순</option>
            <option value="count_comments">댓글 적은 순</option>
            <option value="-today_count">오늘 많이 조회된 순</option>
            <option value="today_count">오늘 적게 조회된 순</option>
            <option value="-yesterday_count">어제 많이 조회된 순</option>
            <option value="yesterday_count">어제 적게 조회된 순</option>
            <option value="-hide">숨긴 글</option>
            <option value="hide">공개 글</option>
        </select>
    </div>
    <div class="col-md-4 mb-2">
        <select class="form-control" id="tag-filter">
            <option value="">태그 (미선택)</option>
            <!-- Tags will be loaded dynamically -->
        </select>
    </div>
    <div class="col-md-4 mb-2">
        <select class="form-control" id="series-filter">
            <option value="">시리즈 (미선택)</option>
            <!-- Series will be loaded dynamically -->
        </select>
    </div>
</div>

<div class="mb-3">
    <input type="text" class="form-control" id="search-input" placeholder="검색어를 입력하세요...">
</div>

<!-- Posts Container -->
<div id="posts-container">
    <div class="text-center py-3">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">로딩중...</span>
        </div>
    </div>
</div>

<!-- Pagination -->
<div id="pagination-container" class="d-flex justify-content-center mt-4"></div>

<script>
let currentParams = {
    page: 1,
    order: '-created_date',
    tag: '',
    series: '',
    search: ''
};

let searchTimeout;
let postsData = [];
let tagsData = [];
let seriesData = [];

function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(searchTimeout);
            func(...args);
        };
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(later, wait);
    };
}

function updateURL() {
    const params = new URLSearchParams();
    Object.entries(currentParams).forEach(([key, value]) => {
        if (value && value !== '') {
            params.set(key, value);
        }
    });
    
    const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newURL);
}

function loadTags() {
    fetch('/v1/setting/tag')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            tagsData = data.body.tags;
            const tagSelect = document.getElementById('tag-filter');
            tagSelect.innerHTML = '<option value="">태그 (미선택)</option>';
            tagsData.forEach(tag => {
                tagSelect.innerHTML += `<option value="${tag.name}">${tag.name} (${tag.count})</option>`;
            });
        }
    });
}

function loadSeries() {
    fetch('/v1/setting/series')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            seriesData = data.body.series;
            const seriesSelect = document.getElementById('series-filter');
            seriesSelect.innerHTML = '<option value="">시리즈 (미선택)</option>';
            seriesData.forEach(series => {
                seriesSelect.innerHTML += `<option value="${series.url}">${series.title} (${series.totalPosts})</option>`;
            });
        }
    });
}

function loadPosts() {
    const container = document.getElementById('posts-container');
    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩중...</span>
            </div>
        </div>
    `;
    
    const params = new URLSearchParams(currentParams);
    fetch(`/v1/setting/posts?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            postsData = data.body.posts;
            renderPosts(data.body);
            updateURL();
        }
    })
    .catch(error => {
        console.error('Error loading posts:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                포스트를 불러오는데 실패했습니다.
            </div>
        `;
    });
}

function renderPosts(data) {
    const container = document.getElementById('posts-container');
    const { posts, page, lastPage, username } = data;
    
    if (posts.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                조건에 맞는 포스트가 없습니다.
            </div>
        `;
        document.getElementById('pagination-container').innerHTML = '';
        return;
    }
    
    container.innerHTML = posts.map((post, idx) => `
        <div class="card setting-card mb-4" data-post-url="${post.url}">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <a href="/@${username}/${post.url}" class="text-decoration-none text-dark fw-bold">
                        ${post.title}
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/@${username}/${post.url}/analytics">분석</a></li>
                            <li><a class="dropdown-item" href="/@${username}/${post.url}/edit">수정</a></li>
                            <li><button class="dropdown-item text-danger" onclick="deletePost('${post.url}')">삭제</button></li>
                        </ul>
                    </div>
                </div>
                
                <div class="text-muted small mb-3">
                    ${post.createdDate}
                    ${post.createdDate !== post.updatedDate ? ` (Updated: ${post.updatedDate})` : ''}
                </div>
                
                <!-- Tag Input -->
                <div class="mb-2">
                    <div class="d-flex" style="gap: 8px;">
                        <input type="text" class="form-control" placeholder="태그" maxlength="50" 
                               value="${post.tag || ''}" onchange="handleTagChange('${post.url}', this.value)" data-original="${post.tag || ''}">
                        <button class="btn btn-primary btn-sm d-none" onclick="submitTagUpdate('${post.url}')" data-tag-btn="${post.url}">
                            업데이트
                        </button>
                    </div>
                </div>
                
                <!-- Series Select -->
                <div class="mb-3">
                    <div class="d-flex" style="gap: 8px;">
                        <select class="form-control" onchange="handleSeriesChange('${post.url}', this.value)" data-original="${post.series || ''}">
                            <option value="">선택하지 않음</option>
                            ${seriesData.map(series => 
                                `<option value="${series.url}" ${post.series === series.url ? 'selected' : ''}>${series.title}</option>`
                            ).join('')}
                        </select>
                        <button class="btn btn-primary btn-sm d-none" onclick="submitSeriesUpdate('${post.url}')" data-series-btn="${post.url}">
                            업데이트
                        </button>
                    </div>
                </div>
                
                ${post.readTime > 30 ? `
                    <div class="alert alert-danger">
                        이 글은 너무 깁니다. 긴 글은 검색 엔진의 색인을 어렵게 만들고 사용자 접근성을 낮춥니다.
                    </div>
                ` : ''}
                
                <div class="d-flex justify-content-between align-items-center text-muted" style="font-size: 12px;">
                    <div class="d-flex" style="gap: 12px;">
                        <button class="btn btn-link btn-sm p-0" onclick="togglePostVisibility('${post.url}', ${!post.isHide})" data-hide-btn="${post.url}">
                            <i class="fas fa-${post.isHide ? 'lock' : 'lock-open'}"></i>
                        </button>
                        <span><i class="far fa-heart"></i> ${post.countLikes}</span>
                        <span><i class="far fa-comment"></i> ${post.countComments}</span>
                    </div>
                    <span>오늘: ${post.todayCount}, 어제: ${post.yesterdayCount}</span>
                </div>
            </div>
        </div>
    `).join('');
    
    // Render pagination
    renderPagination(page, lastPage);
}

function renderPagination(currentPage, lastPage) {
    const container = document.getElementById('pagination-container');
    
    if (lastPage <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let paginationHTML = '<nav><ul class="pagination">';
    
    // Previous button
    paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <button class="page-link" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>이전</button>
    </li>`;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(lastPage, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <button class="page-link" onclick="changePage(${i})">${i}</button>
        </li>`;
    }
    
    // Next button
    paginationHTML += `<li class="page-item ${currentPage === lastPage ? 'disabled' : ''}">
        <button class="page-link" onclick="changePage(${currentPage + 1})" ${currentPage === lastPage ? 'disabled' : ''}>다음</button>
    </li>`;
    
    paginationHTML += '</ul></nav>';
    container.innerHTML = paginationHTML;
}

function changePage(page) {
    if (page < 1) return;
    currentParams.page = page;
    loadPosts();
}

function handleTagChange(postUrl, newValue) {
    const input = event.target;
    const originalValue = input.dataset.original;
    const btn = document.querySelector(`[data-tag-btn="${postUrl}"]`);
    
    if (newValue !== originalValue) {
        btn.classList.remove('d-none');
    } else {
        btn.classList.add('d-none');
    }
}

function handleSeriesChange(postUrl, newValue) {
    const select = event.target;
    const originalValue = select.dataset.original;
    const btn = document.querySelector(`[data-series-btn="${postUrl}"]`);
    
    if (newValue !== originalValue) {
        btn.classList.remove('d-none');
    } else {
        btn.classList.add('d-none');
    }
}

function submitTagUpdate(postUrl) {
    const input = document.querySelector(`[data-post-url="${postUrl}"] input[placeholder="태그"]`);
    const btn = document.querySelector(`[data-tag-btn="${postUrl}"]`);
    
    fetch(`/v1/users/@{{ user.username }}/${postUrl}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ type: 'tag', tag: input.value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            input.dataset.original = input.value;
            btn.classList.add('d-none');
            showMessage('success', '태그가 수정되었습니다.');
        }
    });
}

function submitSeriesUpdate(postUrl) {
    const select = document.querySelector(`[data-post-url="${postUrl}"] select`);
    const btn = document.querySelector(`[data-series-btn="${postUrl}"]`);
    
    fetch(`/v1/users/@{{ user.username }}/${postUrl}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ type: 'series', series: select.value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            select.dataset.original = select.value;
            btn.classList.add('d-none');
            showMessage('success', '시리즈가 수정되었습니다.');
        }
    });
}

function togglePostVisibility(postUrl, hide) {
    fetch(`/v1/users/@{{ user.username }}/${postUrl}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ type: 'hide', hide: hide })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            const btn = document.querySelector(`[data-hide-btn="${postUrl}"] i`);
            btn.className = `fas fa-${data.body.isHide ? 'lock' : 'lock-open'}`;
            btn.parentElement.onclick = () => togglePostVisibility(postUrl, !data.body.isHide);
        }
    });
}

function deletePost(postUrl) {
    if (confirm('정말 이 포스트를 삭제할까요?')) {
        fetch(`/v1/users/@{{ user.username }}/${postUrl}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'DONE') {
                showMessage('success', '포스트가 삭제되었습니다.');
                loadPosts(); // Reload the posts
            }
        });
    }
}

function showMessage(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Event listeners
document.getElementById('order-select').addEventListener('change', function() {
    currentParams.order = this.value;
    currentParams.page = 1;
    loadPosts();
});

document.getElementById('tag-filter').addEventListener('change', function() {
    currentParams.tag = this.value;
    currentParams.page = 1;
    loadPosts();
});

document.getElementById('series-filter').addEventListener('change', function() {
    currentParams.series = this.value;
    currentParams.page = 1;
    loadPosts();
});

document.getElementById('search-input').addEventListener('input', debounce(function() {
    currentParams.search = this.value;
    currentParams.page = 1;
    loadPosts();
}, 300));

// Initialize from URL parameters
function initFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    currentParams.page = parseInt(urlParams.get('page')) || 1;
    currentParams.order = urlParams.get('order') || '-created_date';
    currentParams.tag = urlParams.get('tag') || '';
    currentParams.series = urlParams.get('series') || '';
    currentParams.search = urlParams.get('search') || '';
    
    // Set form values
    document.getElementById('order-select').value = currentParams.order;
    document.getElementById('search-input').value = currentParams.search;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initFromURL();
    loadTags();
    loadSeries();
    loadPosts();
    
    // Set initial filter values after data is loaded
    setTimeout(() => {
        document.getElementById('tag-filter').value = currentParams.tag;
        document.getElementById('series-filter').value = currentParams.series;
    }, 1000);
});
</script>
{% endblock %}
