{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}계정 설정{% endblock %}

{% block setting_content %}
<form method="post" action="{% url 'setting_account' %}">
    {% csrf_token %}
    <div class="setting-card">
        <div class="setting-card-title">가입일</div>
        <p class="mb-0">{{ user.date_joined|date:"Y년 m월 d일" }}</p>
    </div>

    <div class="setting-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="setting-card-title">사용자 필명</div>
            <div>
                <button type="button" class="btn btn-primary" id="edit-username-btn" style="display: inline-block;">변경</button>
                <button type="button" class="btn btn-primary" id="save-username-btn" style="display: none;">업데이트</button>
                <button type="button" class="btn btn-secondary" id="cancel-username-btn" style="display: none;">취소</button>
            </div>
        </div>
        <div class="alert alert-warning mb-3">
            사용자의 필명은 로그인시 사용되며 주소(URL)에 표기되는 이름입니다.
            작성한 포스트가 존재하는 경우 6개월에 한번만 변경할 수 있습니다.
        </div>
        <div id="username-display" style="display: block;">{{ user.username }}</div>
        <input type="text" class="form-control" id="username-input" name="username" value="{{ user.username }}" style="display: none;">
    </div>

    <div class="setting-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="setting-card-title">사용자 이름</div>
            <button type="submit" name="update_name" class="btn btn-primary">업데이트</button>
        </div>
        <input type="text" class="form-control" name="name" placeholder="사용자 실명" maxlength="30" value="{{ user.first_name }} {{ user.last_name }}">
    </div>

    <div class="setting-card">
        <div class="setting-card-title">이메일</div>
        <p class="mb-0">{{ user.email }}</p>
    </div>

    <div class="setting-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="setting-card-title">비밀번호 변경</div>
            <button type="submit" name="update_password" class="btn btn-primary">업데이트</button>
        </div>
        <div class="alert alert-warning mb-3">
            비밀번호는 8자 이상, 소문자, 대문자, 숫자, 특수문자를 포함해야 합니다.
        </div>
        <div class="form-group">
            <input type="password" class="form-control" name="new_password" placeholder="새 비밀번호" maxlength="200">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" name="confirm_password" placeholder="비밀번호 확인" maxlength="200">
        </div>
    </div>
</form>

<div style="text-align: right; margin-bottom: 24px;">
    {% if has_2fa %}
    <button type="button" class="btn btn-danger" onclick="disable2FA()">2차 인증 중지</button>
    {% else %}
    <button type="button" class="btn btn-primary" onclick="enable2FA()">2차 인증 활성화</button>
    {% endif %}
    <button type="button" class="btn btn-danger" onclick="deleteAccount()">계정 삭제</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('edit-username-btn');
    const saveBtn = document.getElementById('save-username-btn');
    const cancelBtn = document.getElementById('cancel-username-btn');
    const usernameDisplay = document.getElementById('username-display');
    const usernameInput = document.getElementById('username-input');

    if (editBtn) {
        editBtn.addEventListener('click', function() {
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            usernameDisplay.style.display = 'none';
            usernameInput.style.display = 'block';
            usernameInput.focus();
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            usernameDisplay.style.display = 'block';
            usernameInput.style.display = 'none';
            usernameInput.value = '{{ user.username }}';
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            const formData = new FormData();
            formData.append('update_username', '1');
            formData.append('username', usernameInput.value);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('{% url "setting_account" %}', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json();
                }
                return response.text().then(text => {
                    if (text.includes('success')) {
                        return { success: true };
                    }
                    return { success: false, message: '오류가 발생했습니다.' };
                });
            })
            .then(data => {
                if (data.success) {
                    usernameDisplay.textContent = usernameInput.value;
                    cancelBtn.click();
                    showMessage('success', '아이디가 변경되었습니다.');
                } else {
                    showMessage('error', data.message || '오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', '네트워크 오류가 발생했습니다.');
            });
        });
    }
});

function disable2FA() {
    if (confirm('정말 2차 인증을 해제할까요?')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            showMessage('error', 'CSRF 토큰을 찾을 수 없습니다.');
            return;
        }

        fetch('/v1/auth/security', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.status === 'DONE') {
                showMessage('success', '2차 인증이 해제되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('error', '해제중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('error', '네트워크 오류가 발생했습니다.');
        });
    }
}

function enable2FA() {
    showMessage('info', '2차 인증 활성화 기능을 구현 중입니다.');
}

function deleteAccount() {
    if (confirm('정말 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        showMessage('info', '계정 삭제 기능을 구현 중입니다.');
    }
}

function showMessage(type, message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-' + (type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    toast.innerHTML = '<strong>' + message + '</strong>';
    
    document.body.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>
{% endblock %}
