{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}프로필 설정{% endblock %}

{% block setting_content %}
<div class="setting-card">
    <div class="setting-card-title">사용자 이미지</div>
    <div style="margin-bottom: 20px;">
        <div style="margin-bottom: 15px;">
            <img src="{{ user.profile.avatar.url|default:'/static/assets/images/default-avatar.jpg' }}" 
                 alt="Profile Image" 
                 id="profile-preview"
                 style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block;">
        </div>
        <input type="file" id="avatar-input" accept="image/*" style="display: none;">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('avatar-input').click()">
            이미지 변경
        </button>
    </div>
</div>

<div class="setting-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="setting-card-title">사용자 상세 소개</div>
        <div>
            <a href="/@{{ user.username }}?preview=about" class="btn btn-secondary" style="margin-right: 8px;">페이지 확인</a>
            <a href="/@{{ user.username }}/about/edit" class="btn btn-primary">소개 작성</a>
        </div>
    </div>
    <div class="alert alert-warning">
        프로필 메인 페이지 상단에 표시됩니다.
    </div>
</div>

<form method="post" action="{% url 'setting_profile' %}" id="profile-form">
    {% csrf_token %}
    <div class="setting-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="setting-card-title">사용자 간단 소개</div>
            <button type="submit" class="btn btn-primary">업데이트</button>
        </div>
        <div class="form-group">
            <input type="url" class="form-control" name="homepage" placeholder="개인 홈페이지" 
                   value="{{ user.profile.homepage|default:'' }}">
        </div>
        <div class="form-group">
            <textarea class="form-control" name="bio" rows="4" placeholder="본인을 한줄로 표현한다면?"
                     >{{ user.profile.bio|default:'' }}</textarea>
        </div>
    </div>
</form>

<div class="setting-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="setting-card-title">소셜 정보</div>
        <button type="button" class="btn btn-primary" onclick="updateSocialLinks()">업데이트</button>
    </div>
    <div id="social-links-container">
        {% for social in social_links %}
        <div class="social-link-item" data-id="{{ social.id }}" style="display: flex; align-items: center; margin-bottom: 10px; gap: 8px;">
            <div style="cursor: grab; padding: 4px 8px;">
                <i class="fas fa-bars"></i>
            </div>
            <div style="width: 16px;">
                <i class="fab fa-{{ social.name }}" id="icon-{{ social.id }}"></i>
            </div>
            <div>
                <select class="form-select" style="width: 120px;" onchange="updateIcon({{ social.id }}, this.value)">
                    <option disabled>아이콘</option>
                    <option value="github" {% if social.name == 'github' %}selected{% endif %}>깃허브</option>
                    <option value="twitter" {% if social.name == 'twitter' %}selected{% endif %}>트위터</option>
                    <option value="facebook" {% if social.name == 'facebook' %}selected{% endif %}>페이스북</option>
                    <option value="telegram" {% if social.name == 'telegram' %}selected{% endif %}>텔레그램</option>
                    <option value="instagram" {% if social.name == 'instagram' %}selected{% endif %}>인스타그램</option>
                    <option value="linkedin" {% if social.name == 'linkedin' %}selected{% endif %}>링크드인</option>
                    <option value="youtube" {% if social.name == 'youtube' %}selected{% endif %}>유튜브</option>
                    <option value="other" {% if social.name == 'other' %}selected{% endif %}>기타</option>
                </select>
            </div>
            <div style="flex-grow: 1;">
                <input type="url" class="form-control" placeholder="주소" value="{{ social.value }}" 
                       data-social-id="{{ social.id }}">
            </div>
            <button type="button" class="btn btn-danger" onclick="removeSocialLink({{ social.id }})" style="padding: 8px 12px; font-size: 12px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    <button type="button" class="btn btn-primary btn-block" onclick="addSocialLink()" style="margin-top: 10px;">
        링크 추가
    </button>
</div>

<script>
let socialLinksData = [
    {% for social in social_links %}
    {
        id: {{ social.id }},
        name: '{{ social.name }}',
        value: '{{ social.value }}',
        order: {{ social.order }},
        prepare: false
    },
    {% endfor %}
];

document.getElementById('avatar-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('avatar', file);
        
        fetch('/v1/setting/avatar', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'DONE') {
                document.getElementById('profile-preview').src = data.body.url;
                showMessage('success', '프로필 이미지가 업데이트되었습니다.');
            } else {
                showMessage('error', '이미지 업로드에 실패했습니다.');
            }
        });
    }
});

function updateIcon(socialId, iconName) {
    const iconElement = document.getElementById('icon-' + socialId);
    iconElement.className = 'fab fa-' + iconName;
    
    const social = socialLinksData.find(s => s.id === socialId);
    if (social) {
        social.name = iconName;
    }
}

function addSocialLink() {
    const container = document.getElementById('social-links-container');
    const newId = Date.now(); // Temporary ID for new items
    
    const newItem = document.createElement('div');
    newItem.className = 'social-link-item mb-2';
    newItem.dataset.id = newId;
    newItem.innerHTML = `
        <div class="d-flex align-items-center gap-2">
            <div class="drag-handle px-2" style="cursor: grab;">
                <i class="fas fa-bars"></i>
            </div>
            <div style="width: 16px;">
                <i class="fab fa-github" id="icon-${newId}"></i>
            </div>
            <div>
                <select class="form-select" style="width: 120px;" onchange="updateIcon(${newId}, this.value)">
                    <option disabled>아이콘</option>
                    <option value="github" selected>깃허브</option>
                    <option value="twitter">트위터</option>
                    <option value="facebook">페이스북</option>
                    <option value="telegram">텔레그램</option>
                    <option value="instagram">인스타그램</option>
                    <option value="linkedin">링크드인</option>
                    <option value="youtube">유튜브</option>
                    <option value="other">기타</option>
                </select>
            </div>
            <div class="flex-grow-1">
                <input type="url" class="form-control" placeholder="주소" data-social-id="${newId}">
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSocialLink(${newId})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    container.appendChild(newItem);
    
    socialLinksData.push({
        id: newId,
        name: 'github',
        value: '',
        order: socialLinksData.length,
        prepare: true
    });
}

function removeSocialLink(socialId) {
    const social = socialLinksData.find(s => s.id === socialId);
    if (social && !social.prepare) {
        if (!confirm('정말 이 링크를 삭제할까요?')) return;
    }
    
    document.querySelector(`[data-id="${socialId}"]`).remove();
    socialLinksData = socialLinksData.filter(s => s.id !== socialId);
}

function updateSocialLinks() {
    // Collect current data from form
    const socialItems = document.querySelectorAll('.social-link-item');
    const updatedData = [];
    
    socialItems.forEach((item, index) => {
        const id = item.dataset.id;
        const nameSelect = item.querySelector('select');
        const valueInput = item.querySelector('input[data-social-id]');
        const social = socialLinksData.find(s => s.id == id);
        
        if (social) {
            social.name = nameSelect.value;
            social.value = valueInput.value;
            social.order = index;
            updatedData.push(social);
        }
    });
    
    // Validate data
    if (updatedData.some(s => !s.name)) {
        showMessage('error', '소셜 아이콘을 모두 선택해주세요.');
        return;
    }
    
    if (updatedData.some(s => !s.value)) {
        showMessage('error', '소셜 주소를 모두 입력해주세요.');
        return;
    }
    
    if (updatedData.some(s => !s.value.startsWith('https://'))) {
        showMessage('error', '소셜 주소는 https:// 로 시작해야 합니다.');
        return;
    }
    
    // Send update request
    const updateItems = updatedData.filter(s => !s.prepare);
    const createItems = updatedData.filter(s => s.prepare);
    
    fetch('/v1/setting/social', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            update: updateItems.map(item => `${item.id},${item.name},${item.value},${item.order}`).join('&'),
            create: createItems.map(item => `${item.name},${item.value},${item.order}`).join('&')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            showMessage('success', '소셜 정보가 업데이트 되었습니다.');
            socialLinksData = data.body.map(social => ({...social, prepare: false}));
        } else {
            showMessage('error', '업데이트에 실패했습니다.');
        }
    });
}

function showMessage(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
