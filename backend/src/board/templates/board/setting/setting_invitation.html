{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}초대 관리{% endblock %}

{% block setting_content %}
<div class="card setting-card">
    <div class="card-header">
        <h5 class="card-title mb-0">에디터 초대 요청</h5>
    </div>
    <div class="card-body" id="invitations-container">
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩중...</span>
            </div>
        </div>
    </div>
</div>

<script>
function loadInvitations() {
    const container = document.getElementById('invitations-container');
    
    fetch('/v1/invitation/requests')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            const invitations = data.body || [];
            
            if (invitations.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        현재 받은 초대 요청이 없습니다.
                    </div>
                `;
            } else {
                container.innerHTML = invitations.map(invitation => `
                    <div class="card mb-3" data-invitation-id="${invitation.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="${invitation.senderImage}" 
                                         alt="Profile" 
                                         style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover;">
                                    <div>
                                        <div class="fw-bold">${invitation.sender}</div>
                                        <div class="text-muted small">${invitation.createdDate}</div>
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="respondToInvitation(${invitation.id}, 'reject')">
                                        거절
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm" 
                                            onclick="respondToInvitation(${invitation.id}, 'accept')">
                                        승낙
                                    </button>
                                </div>
                            </div>
                            <div class="mb-0">
                                <textarea class="form-control" readonly rows="3">${invitation.content}</textarea>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    })
    .catch(error => {
        console.error('Error loading invitations:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                초대 요청을 불러오는데 실패했습니다.
            </div>
        `;
    });
}

function respondToInvitation(invitationId, action) {
    const actionText = action === 'accept' ? '승낙' : '거절';
    
    if (!confirm(`정말 이 초대를 ${actionText}하시겠습니까?`)) {
        return;
    }
    
    fetch(`/v1/invitation/${invitationId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            showMessage('success', `초대를 ${actionText}했습니다.`);
            
            // Remove the invitation from the list
            const invitationElement = document.querySelector(`[data-invitation-id="${invitationId}"]`);
            if (invitationElement) {
                invitationElement.remove();
                
                // Check if no invitations left
                const remainingInvitations = document.querySelectorAll('[data-invitation-id]');
                if (remainingInvitations.length === 0) {
                    document.getElementById('invitations-container').innerHTML = `
                        <div class="alert alert-info">
                            현재 받은 초대 요청이 없습니다.
                        </div>
                    `;
                }
            }
        } else {
            showMessage('error', data.errorMessage || `초대 ${actionText}에 실패했습니다.`);
        }
    })
    .catch(error => {
        console.error('Error responding to invitation:', error);
        showMessage('error', `초대 ${actionText}에 실패했습니다.`);
    });
}

function showMessage(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadInvitations();
});
</script>
{% endblock %}
