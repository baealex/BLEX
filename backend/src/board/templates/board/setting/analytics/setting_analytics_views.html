{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}조회수 통계{% endblock %}

{% block setting_content %}
<div class="card setting-card mb-4" id="views-chart-container">
    <div class="card-header">
        <h5 class="card-title mb-3">조회수 추이</h5>
        <div class="d-flex justify-content-between text-muted small">
            <span>총 조회수: <span id="total-views">로딩중...</span></span>
            <span>기간: 30일 이내</span>
        </div>
    </div>
    <div class="card-body">
        <canvas id="views-chart" width="400" height="200"></canvas>
    </div>
</div>

<div class="card setting-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <input type="date" id="date-picker" class="form-control" style="width: auto;">
                <h5 class="mb-0">의 인기글</h5>
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="prev-day">이전</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="next-day">다음</button>
            </div>
        </div>
    </div>
    <div class="card-body" id="popular-posts-container">
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩중...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;
let currentDate = new Date();
currentDate.setDate(currentDate.getDate() - 1); // Yesterday

// Initialize date picker
const datePicker = document.getElementById('date-picker');
const minDate = new Date();
minDate.setDate(minDate.getDate() - 30);
const maxDate = new Date();
maxDate.setDate(maxDate.getDate() - 1);

datePicker.min = minDate.toISOString().split('T')[0];
datePicker.max = maxDate.toISOString().split('T')[0];
datePicker.value = currentDate.toISOString().split('T')[0];

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function updateDatePicker() {
    datePicker.value = formatDate(currentDate);
    updateNavigationButtons();
    loadPopularPosts();
}

function updateNavigationButtons() {
    document.getElementById('prev-day').disabled = currentDate <= minDate;
    document.getElementById('next-day').disabled = currentDate >= maxDate;
}

// Load views chart data
function loadViewsChart() {
    fetch('/v1/setting/analytics/view')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            const { views, total } = data.body;
            document.getElementById('total-views').textContent = total.toLocaleString();
            
            const labels = views.map(item => item.date).reverse();
            const counts = views.map(item => item.count).reverse();
            
            const ctx = document.getElementById('views-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'View',
                        data: counts,
                        borderColor: '#A076F1',
                        backgroundColor: '#A076F1',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error loading views chart:', error);
        document.getElementById('total-views').textContent = '오류';
    });
}

// Load popular posts for specific date
function loadPopularPosts() {
    const container = document.getElementById('popular-posts-container');
    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩중...</span>
            </div>
        </div>
    `;
    
    fetch(`/v1/setting/analytics/posts-view?date=${formatDate(currentDate)}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE') {
            const { posts } = data.body;
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        아직 작성한 포스트가 없습니다.
                    </div>
                `;
            } else {
                container.innerHTML = posts.map((post, idx) => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="/@${post.author}/${post.url}" class="text-decoration-none text-dark">
                                    ${idx + 1}. ${post.title}
                                </a>
                                <div class="text-muted small">
                                    ${post.todayCount}명 읽음
                                    <span class="ms-1" style="color: ${post.increaseCount > 0 ? '#ff6700' : '#008fff'};">
                                        (${post.increaseCount > 0 ? '↑' : '↓'}${Math.abs(post.increaseCount)})
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    })
    .catch(error => {
        console.error('Error loading popular posts:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                포스트를 불러오는데 실패했습니다.
            </div>
        `;
    });
}

// Event listeners
document.getElementById('prev-day').addEventListener('click', function() {
    currentDate.setDate(currentDate.getDate() - 1);
    updateDatePicker();
});

document.getElementById('next-day').addEventListener('click', function() {
    currentDate.setDate(currentDate.getDate() + 1);
    updateDatePicker();
});

datePicker.addEventListener('change', function() {
    currentDate = new Date(this.value);
    updateNavigationButtons();
    loadPopularPosts();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadViewsChart();
    updateNavigationButtons();
    loadPopularPosts();
});
</script>
{% endblock %}