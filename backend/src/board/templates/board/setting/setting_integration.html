{% extends 'board/setting/setting_base.html' %}
{% load static %}

{% block setting_title %}연동 설정{% endblock %}

{% block setting_content %}
<div class="card setting-card">
    <div class="card-body">
        <div style="line-height: 1.75;">
            <div class="mb-3">
                <strong>텔레그램과 연동하면 어떤 효과가 있나요?</strong>
            </div>
            <ul class="mb-3">
                <li>실시간으로 회원님의 알림을 전달해 드립니다.</li>
                <li>로그인시 2차 인증을 사용할 수 있습니다.</li>
            </ul>
            
            {% if not telegram_connection.is_connected %}
            <div class="my-3">
                <strong>어떻게 연동하나요?</strong>
                <ul>
                    <li>텔레그램을 실행하고 <a href="http://t.me/blex_bot" class="text-decoration-none">@blex_bot</a>을 추가해주세요!</li>
                    <li>봇에게 <code class="bg-primary text-white px-2 py-1 rounded" id="telegram-token">{{ telegram_token }}</code>을 전송해주세요!</li>
                </ul>
            </div>
            <div class="text-muted">
                해당 토큰은 회원님을 위해 생성된 일회성 토큰이며 연동을 완료되거나 오늘이 지나면 파기됩니다.
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if telegram_connection.is_connected %}
<div class="card setting-card mt-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <div class="d-flex align-items-center mb-2">
                    <i class="fab fa-telegram-plane text-primary fs-4 me-2"></i>
                    <span class="fw-bold">연동된 아이디</span>
                </div>
                <div class="fs-5">{{ telegram_connection.telegram_id }}</div>
            </div>
        </div>
        <button type="button" class="btn btn-outline-danger w-100 mt-3" onclick="disconnectTelegram()">
            연동 해제
        </button>
    </div>
</div>
{% endif %}

<script>
{% if not telegram_connection.is_connected %}
// Auto-refresh token if needed
let tokenRefreshInterval;

function refreshToken() {
    fetch('/v1/telegram/makeToken', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE' && data.body.token) {
            document.getElementById('telegram-token').textContent = data.body.token;
        }
    });
}

// Check connection status periodically
function checkConnectionStatus() {
    fetch('/v1/telegram/status')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'DONE' && data.body.isConnected) {
            location.reload(); // Refresh page to show connected state
        }
    });
}

// Start checking connection status every 5 seconds
setInterval(checkConnectionStatus, 5000);
{% endif %}

function disconnectTelegram() {
    if (confirm('정말 연동을 해제할까요?')) {
        fetch('/v1/telegram/unsync', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'DONE') {
                showMessage('success', '연동이 해제되었습니다.');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('error', data.errorMessage || '연동 해제에 실패했습니다.');
            }
        });
    }
}

function showMessage(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
