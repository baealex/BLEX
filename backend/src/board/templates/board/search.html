{% extends 'board/base.html' %}
{% load static %}
{% load react_tags %}

{% block title %}{% if query %}'{{ query }}' 검색 결과{% else %}검색어를 입력하세요.{% endif %}{% endblock %}

{% block search_active %}active{% endblock %}

{% block extra_styles %}
<style>
    /* 검색 페이지 스타일 */
    .search-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 0;
    }

    .search-box-container {
        margin-bottom: 24px;
    }

    .search-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
    }

    .search-query {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
    }

    .search-stats {
        color: #666;
        font-size: 14px;
    }

    .search-results {
        margin-top: 24px;
        margin-bottom: 40px;
    }

    .search-result-item {
        padding: 24px 0;
        border-bottom: 1px solid #eee;
    }

    .search-result-item:first-child {
        border-top: 1px solid #eee;
    }

    .search-result-item:last-child {
        margin-bottom: 20px;
    }

    .search-positions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
        font-size: 13px;
        color: #888;
    }

    .no-results {
        padding: 40px 20px;
        text-align: center;
        background-color: #f9f9f9;
        border-radius: 8px;
        color: #666;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 60px 0;
    }

    .loading-spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid #4568dc;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* 다크 모드 지원 */
    body:not(.light) .search-result-item {
        border-color: #333;
    }

    body:not(.light) .search-query,
    body:not(.light) .search-stats {
        color: #aaa;
    }

    body:not(.light) .search-positions {
        color: #777;
    }

    body:not(.light) .no-results {
        background-color: #222;
        color: #aaa;
    }

    body:not(.light) .loading-spinner {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: #4568dc;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-box-container">
        <island-component name="SearchBox"
            props="{ query: '{{ query }}', username: '{{ username }}' }"></island-component>
    </div>

    {% if is_loading %}
    <div class="loading-container">
        <div class="loading-spinner"></div>
    </div>
    {% elif error_message %}
    <div class="no-results">
        {{ error_message }}
    </div>
    {% elif not results %}
    <div class="no-results">
        검색 결과가 없습니다.
    </div>
    {% else %}
    <div class="search-info">
        <div class="search-query">
            <i class="fas fa-search"></i>
            '{{ query }}{% if username %} of @{{ username }}{% endif %}' 검색
        </div>
        <div class="search-stats">
            {{ total_size }}개의 결과 ({{ elapsed_time }}초 소요)
        </div>
    </div>

    <div class="search-results">
        {% for result in results %}
        <div class="search-result-item">
            <article class="post-card">
                <div class="post-content">
                    <div class="post-author-container">
                        <a href="/@{{ result.author_username }}">
                            <img class="post-author-image"
                                src="{% if result.author_image %}{{ result.author_image.url }}{% else %}{% static 'default_avatar.jpg' %}{% endif %}"
                                alt="{{ result.author_username }}">
                        </a>
                        <div class="post-author-info">
                            <a href="/@{{ result.author_username }}" class="post-author-name">
                                {{ result.author_username }}
                            </a>
                            <div class="post-meta">
                                {{ result.created_date }} · {{ result.read_time }}분 분량
                            </div>
                        </div>
                    </div>
                    <h3 class="post-title">
                        <a href="/@{{ result.author_username }}/{{ result.url }}">{{ result.title }}</a>
                    </h3>
                    <p class="post-description">{{ result.meta_description }}</p>
                    <div class="post-footer">
                        {% if result.series %}
                        <a href="/@{{ result.author_username }}/series/{{ result.series.url }}">
                            <span class="series-badge">{{ result.series.name }}</span>
                        </a>
                        {% else %}
                        <div></div>
                        {% endif %}
                        <div class="post-stats">
                            <div class="stat-item">
                                <i class="far fa-comment"></i>
                                <span>{{ result.count_comments }}</span>
                            </div>
                            <div class="post-meta-item">
                                {% react_component 'LikeButton' postId=result.url likesCount=result.count_likes
                                hasLiked=result.has_liked %}
                            </div>
                        </div>
                    </div>
                </div>
            </article>
            <div class="search-positions">
                {{ result.positions|join:", " }}에서 검색됨
            </div>
        </div>
        {% endfor %}
    </div>

    {% if last_page > 0 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?q={{ query }}&u={{ username }}&page={{ page|add:'-1' }}" class="page-link">&laquo; 이전</a>
        {% endif %}

        {% for p in page_range %}
        {% if p == page %}
        <span class="page-link active">{{ p }}</span>
        {% else %}
        <a href="?q={{ query }}&u={{ username }}&page={{ p }}" class="page-link">{{ p }}</a>
        {% endif %}
        {% endfor %}

        {% if page < last_page %} <a href="?q={{ query }}&u={{ username }}&page={{ page|add:'1' }}" class="page-link">다음
            &raquo;</a>
            {% endif %}
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // 페이지네이션 범위 계산을 위한 스크립트가 필요하다면 여기에 추가
</script>
{% endblock %}
