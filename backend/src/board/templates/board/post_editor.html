{% extends 'board/base.html' %}
{% load static %}
{% load island %}

{% block title %}{% if is_edit %}Edit Post{% else %}Write Post{% endif %} - BLEX{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% island_css 'styles/post.scss' %}">
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50 py-8" x-data="postEditor">
    <div class="max-w-7xl mx-auto px-6">
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-sm border border-slate-200 mb-8 p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <h1 class="text-3xl font-bold text-slate-900">
                    {% if is_edit %}Edit Post{% else %}Write New Post{% endif %}
                </h1>
                <div class="flex gap-3">
                    <button type="button" 
                            @click="saveDraft" 
                            class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 hover:border-slate-400 transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Save Draft
                    </button>
                    <button type="button" 
                            @click="publishPost" 
                            class="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        {% if is_edit %}Update{% else %}Publish{% endif %}
                    </button>
                </div>
            </div>
        </header>

        <form id="postForm" method="POST" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}
            
            <!-- Title -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <label for="title" class="block text-sm font-semibold text-slate-700 mb-2">Title</label>
                <input type="text" 
                       id="title" 
                       name="title" 
                       x-model="form.title"
                       class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg placeholder-slate-400" 
                       placeholder="Enter your post title..."
                       value="{{ post.title }}" 
                       required>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <!-- Main Editor -->
                <div class="xl:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label for="content" class="block text-sm font-semibold text-slate-700 mb-4">Content</label>
                        {% island_component 'MarkdownEditor' content=post.content.text_md name='text_md' %}
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="xl:col-span-1 space-y-6">
                    <!-- URL -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label for="url" class="block text-sm font-semibold text-slate-700 mb-2">URL Slug</label>
                        <input type="text" 
                               id="url" 
                               name="url" 
                               x-model="form.url"
                               class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="post-url-slug"
                               value="{{ post.url }}" 
                               required>
                    </div>

                    <!-- Cover Image -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">Cover Image</label>
                        
                        <div class="space-y-4">
                            <label class="flex items-center justify-center gap-3 w-full px-4 py-3 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all duration-200">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <span class="text-slate-600 font-medium">Upload Image</span>
                                <input type="file" 
                                       id="image" 
                                       name="image" 
                                       class="hidden" 
                                       accept="image/*"
                                       @change="handleImageUpload">
                            </label>
                            
                            <div x-show="imagePreview" x-transition class="relative">
                                <img :src="imagePreview" alt="Cover Image" class="w-full h-48 object-cover rounded-lg">
                                <button type="button" 
                                        @click="removeImage"
                                        class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Meta Description -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label for="meta_description" class="block text-sm font-semibold text-slate-700 mb-2">Meta Description</label>
                        <textarea id="meta_description" 
                                  name="meta_description" 
                                  x-model="form.metaDescription"
                                  class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                                  rows="3"
                                  maxlength="150"
                                  placeholder="Brief description for SEO...">{{ post.meta_description }}</textarea>
                        <div class="flex justify-between items-center mt-2">
                            <small class="text-slate-500">SEO description for search engines</small>
                            <small class="text-slate-400" x-text="`${form.metaDescription.length}/150`">0/150</small>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">Tags</label>
                        
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" 
                                       x-model="newTag"
                                       @keydown.enter.prevent="addTag"
                                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                       placeholder="Add tag...">
                                <button type="button" 
                                        @click="addTag"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Add
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-2" x-show="tags.length > 0">
                                <template x-for="(tag, index) in tags" :key="tag">
                                    <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                        <span x-text="tag"></span>
                                        <button type="button" 
                                                @click="removeTag(index)"
                                                class="w-4 h-4 hover:bg-blue-200 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </span>
                                </template>
                            </div>
                            
                            <input type="hidden" id="tags" name="tags" :value="tags.join(',')">
                        </div>
                    </div>

                    <!-- Series -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">Series</label>
                        
                        <div class="relative" x-data="{ open: false }">
                            <button type="button" 
                                    @click="open = !open"
                                    class="w-full flex items-center justify-between px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <span x-text="selectedSeriesName || 'Select Series'" class="text-slate-700"></span>
                                <svg class="w-5 h-5 text-slate-400 transition-transform" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            
                            <div x-show="open" 
                                 x-transition 
                                 @click.outside="open = false"
                                 class="absolute z-10 w-full mt-2 bg-white border border-slate-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                                <div @click="selectSeries('', 'None'); open = false" 
                                     class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100">
                                    None
                                </div>
                                {% for series in series_list %}
                                <div @click="selectSeries('{{ series.id }}', '{{ series.name }}'); open = false" 
                                     class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0 {% if post.series and post.series.id == series.id %}bg-blue-50 text-blue-700{% endif %}">
                                    {{ series.name }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <input type="hidden" id="series" name="series" x-model="selectedSeriesId" value="{{ post.series.id|default:'' }}">
                        </div>
                    </div>

                    <!-- Post Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-slate-700 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Post Settings
                        </h3>
                        
                        <div class="space-y-4">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="hide" 
                                       name="hide" 
                                       x-model="form.hide"
                                       class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.hide %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900">Hide from public</div>
                                    <div class="text-sm text-slate-500">Only you can see this post</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="notice" 
                                       name="notice" 
                                       x-model="form.notice"
                                       class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.notice %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900">Pin as notice</div>
                                    <div class="text-sm text-slate-500">Pin this post at the top of your blog</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="advertise" 
                                       name="advertise" 
                                       x-model="form.advertise"
                                       class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.advertise %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900">Show advertisements</div>
                                    <div class="text-sm text-slate-500">Display ads in this post</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    {% if is_edit %}
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-red-700 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            Danger Zone
                        </h3>
                        <button type="button" 
                                @click="deletePost"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Delete this post
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 태그 입력 처리
        const tagInput = document.getElementById('tagInput');
        const tagList = document.getElementById('tagList');
        const tagsHidden = document.getElementById('tags');
        let tags = tagsHidden.value ? tagsHidden.value.split(',') : [];
        
        // 태그 추가 함수
        function addTag(tag) {
            tag = tag.trim();
            if (tag === '' || tags.includes(tag)) return;
            
            tags.push(tag);
            updateTagsInput();
            
            const tagItem = document.createElement('div');
            tagItem.className = 'tag-item';
            tagItem.dataset.tag = tag;
            tagItem.innerHTML = `
                <span>${tag}</span>
                <span class="tag-remove">&times;</span>
            `;
            
            tagList.appendChild(tagItem);
            tagInput.value = '';
            
            // 태그 삭제 이벤트 추가
            tagItem.querySelector('.tag-remove').addEventListener('click', function() {
                removeTag(tag);
                tagItem.remove();
            });
        }
        
        // 태그 삭제 함수
        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            updateTagsInput();
        }
        
        // 태그 hidden input 업데이트
        function updateTagsInput() {
            tagsHidden.value = tags.join(',');
        }
        
        // 태그 입력 이벤트
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(this.value);
            }
        });
        
        // 기존 태그 삭제 이벤트 추가
        document.querySelectorAll('.tag-item .tag-remove').forEach(item => {
            item.addEventListener('click', function() {
                const tagItem = this.closest('.tag-item');
                const tag = tagItem.dataset.tag;
                removeTag(tag);
                tagItem.remove();
            });
        });
        
        // 시리즈 선택 드롭다운
        const seriesToggle = document.getElementById('seriesToggle');
        const seriesMenu = document.getElementById('seriesMenu');
        const seriesDropdown = document.querySelector('.series-dropdown');
        const seriesItems = document.querySelectorAll('.series-dropdown-item');
        const seriesInput = document.getElementById('series');
        const selectedSeries = document.getElementById('selectedSeries');
        
        // 시리즈 드롭다운 토글
        seriesToggle.addEventListener('click', function() {
            seriesDropdown.classList.toggle('open');
        });
        
        // 시리즈 아이템 선택
        seriesItems.forEach(item => {
            item.addEventListener('click', function() {
                const id = this.dataset.id;
                const name = this.textContent.trim();
                
                seriesInput.value = id;
                selectedSeries.textContent = name || 'Select Series';
                
                // 활성 클래스 업데이트
                seriesItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                seriesDropdown.classList.remove('open');
            });
        });
        
        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            if (!seriesDropdown.contains(e.target)) {
                seriesDropdown.classList.remove('open');
            }
        });
        
        // 이미지 업로드 프리뷰
        const imageInput = document.getElementById('image');
        const imagePreview = document.querySelector('.image-preview');
        const imagePreviewImg = imagePreview.querySelector('img');
        const removeImageBtn = document.getElementById('removeImage');
        
        // 이미지 업로드 시 프리뷰
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imagePreviewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // 이미지 제거
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', function() {
                imagePreviewImg.src = '';
                imagePreview.style.display = 'none';
                imageInput.value = '';
                
                // 이미지 삭제 플래그 추가
                const removeImageFlag = document.getElementById('remove_image') || document.createElement('input');
                removeImageFlag.type = 'hidden';
                removeImageFlag.id = 'remove_image';
                removeImageFlag.name = 'remove_image';
                removeImageFlag.value = 'true';
                document.getElementById('postForm').appendChild(removeImageFlag);
            });
        }
        
        // 폼 제출 처리
        const postForm = document.getElementById('postForm');
        const saveButton = document.getElementById('saveButton');
        const draftButton = document.getElementById('draftButton');
        const deleteButton = document.getElementById('deleteButton');
        const contentInput = document.getElementById('content');
        
        // 게시 버튼
        saveButton.addEventListener('click', function() {
            // 마크다운 에디터 내용 가져오기 (이 부분은 MarkdownEditor 컴포넌트와 연동 필요)
            // contentInput.value = 마크다운 내용;
            
            // 폼 제출
            postForm.submit();
        });
        
        // 임시저장 버튼
        if (draftButton) {
            draftButton.addEventListener('click', function() {
                // 임시저장 플래그 추가
                const draftFlag = document.getElementById('is_draft') || document.createElement('input');
                draftFlag.type = 'hidden';
                draftFlag.id = 'is_draft';
                draftFlag.name = 'is_draft';
                draftFlag.value = 'true';
                postForm.appendChild(draftFlag);
                
                // 폼 제출
                postForm.submit();
            });
        }
        
        // 삭제 버튼
        if (deleteButton) {
            deleteButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this post?')) {
                    // 삭제 플래그 추가
                    const deleteFlag = document.getElementById('delete') || document.createElement('input');
                    deleteFlag.type = 'hidden';
                    deleteFlag.id = 'delete';
                    deleteFlag.name = 'delete';
                    deleteFlag.value = 'true';
                    postForm.appendChild(deleteFlag);
                    
                    // 폼 제출
                    postForm.submit();
                }
            });
        }
    });
</script>
{% endblock %}
