{% extends 'board/base.html' %}
{% load static %}
{% load island %}

{% block title %}{% if is_edit %}Edit Post{% else %}Write Post{% endif %} - BLEX{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% island_css 'styles/post.scss' %}">
{% endblock %}

{% block content %}
<div class="bg-slate-50 py-4 sm:py-8" x-data="postEditor">
    <div class="max-w-7xl w-full mx-auto">
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 sm:mb-8 p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900">
                    {% if is_edit %}게시글 수정{% else %}새 게시글 작성{% endif %}
                </h1>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    {% if not is_edit %}
                    <button type="button" 
                            @click="saveDraft" 
                            class="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 hover:border-slate-400 transition-all duration-200 w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        임시저장
                    </button>
                    {% endif %}
                    <button type="button" 
                            @click="publishPost" 
                            class="flex items-center justify-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        {% if is_edit %}수정{% else %}게시{% endif %}
                    </button>
                </div>
            </div>
        </header>

        <form id="postForm" method="POST" enctype="multipart/form-data" class="space-y-6 sm:space-y-8">
            {% csrf_token %}
            
            <!-- Title -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                <label for="title" class="block text-sm font-semibold text-slate-700 mb-2">제목</label>
                <input type="text" 
                       id="title" 
                       name="title" 
                       x-model="form.title"
                       @input="generateUrlFromTitle"
                       class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-solid border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base sm:text-lg placeholder-slate-400" 
                       placeholder="게시글 제목을 입력하세요..."
                       value="{{ post.title }}" 
                       required>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
                <!-- Main Editor -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label for="content" class="block text-sm font-semibold text-slate-700 mb-4">내용</label>
                        {% island_component 'MarkdownEditor' content=post.content.text_md name='text_md' %}
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- URL -->
                    {% if not is_edit %}
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label for="url" class="block text-sm font-semibold text-slate-700 mb-2">URL 주소</label>
                        <input type="text" 
                               id="url" 
                               name="url" 
                               x-model="form.url"
                               @input="form.url = $event.target.value.toLowerCase().replace(/[^a-z0-9가-힣\s-]/g, '').replace(/\s+/g, '-')"
                               class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-solid border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                               placeholder="게시글-url-주소"
                               value="{{ post.url }}" 
                               required>
                        <small class="text-slate-500 mt-2 block">URL이 중복되면 자동으로 번호가 추가됩니다.</small>
                    </div>
                    {% else %}
                    <!-- Hidden URL field for edit mode -->
                    <input type="hidden" name="url" value="{{ post.url }}">
                    {% endif %}

                    <!-- Cover Image -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">커버 이미지</label>
                        
                        <div class="space-y-4">
                            <label class="flex items-center justify-center gap-2 sm:gap-3 w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all duration-200">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <span class="text-slate-600 font-medium text-sm sm:text-base">이미지 업로드</span>
                                <input type="file" 
                                       id="image" 
                                       name="image" 
                                       class="hidden" 
                                       accept="image/*"
                                       @change="handleImageUpload">
                            </label>
                            
                            <div x-show="imagePreview" x-transition class="relative">
                                <img :src="imagePreview" alt="Cover Image" class="w-full h-32 sm:h-48 object-cover rounded-lg">
                                <button type="button" 
                                        @click="removeImage"
                                        class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Meta Description -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label for="meta_description" class="block text-sm font-semibold text-slate-700 mb-2">메타 설명</label>
                        <textarea id="meta_description" 
                                  name="meta_description" 
                                  x-model="form.metaDescription"
                                  class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-solid border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm sm:text-base" 
                                  rows="3"
                                  maxlength="150"
                                  placeholder="SEO를 위한 간단한 설명...">{{ post.meta_description }}</textarea>
                        <div class="flex justify-between items-center mt-2">
                            <small class="text-slate-500">검색엔진을 위한 SEO 설명</small>
                            <small class="text-slate-400" x-text="`${form.metaDescription.length}/150`">0/150</small>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">태그</label>
                        
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" 
                                       x-model="newTag"
                                       @keydown.enter.prevent="addTag"
                                       @input="newTag = $event.target.value.toLowerCase().replace(/[^a-z0-9가-힣\s]/g, '').replace(/\s+/g, '-')"
                                       class="flex-1 w-full px-3 py-2 border border-solid border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" 
                                       placeholder="태그 입력...">
                                <button type="button" 
                                        @click="addTag"
                                        :disabled="!newTag.trim()"
                                        class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed text-sm sm:text-base">
                                    추가
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-2" x-show="tags.length > 0">
                                <template x-for="(tag, index) in tags" :key="tag">
                                    <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                        <span x-text="tag"></span>
                                        <button type="button" 
                                                @click="removeTag(index)"
                                                class="w-4 h-4 hover:bg-blue-200 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </span>
                                </template>
                            </div>
                            
                            <input type="hidden" id="tags" name="tags" :value="tags.join(',')">
                        </div>
                    </div>

                    <!-- Series -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-4">시리즈</label>
                        
                        <div class="relative" x-data="{ open: false }">
                            <button type="button" 
                                    @click="open = !open"
                                    class="w-full flex items-center justify-between px-3 sm:px-4 py-2 sm:py-3 border border-solid border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                                <span x-text="selectedSeriesName || '시리즈 선택'" class="text-slate-700"></span>
                                <svg class="w-5 h-5 text-slate-400 transition-transform" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            
                            <div x-show="open" 
                                 x-transition 
                                 @click.outside="open = false"
                                 class="absolute z-10 w-full mt-2 bg-white border border-slate-300 rounded-lg shadow-lg max-h-48 sm:max-h-64 overflow-y-auto">
                                <div @click="selectSeries('', 'None'); open = false" 
                                     class="px-3 sm:px-4 py-2 sm:py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 text-sm sm:text-base">
                                    없음
                                </div>
                                {% for series in series_list %}
                                <div @click="selectSeries('{{ series.id }}', '{{ series.name }}'); open = false" 
                                     class="px-3 sm:px-4 py-2 sm:py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0 text-sm sm:text-base {% if post.series and post.series.id == series.id %}bg-blue-50 text-blue-700{% endif %}">
                                    {{ series.name }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <input type="hidden" id="series" name="series" x-model="selectedSeriesId" value="{{ post.series.id|default:'' }}">
                        </div>
                    </div>

                    <!-- Post Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                        <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold text-slate-700 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            게시글 설정
                        </h3>
                        
                        <div class="space-y-4">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="hide" 
                                       name="hide" 
                                       x-model="form.hide"
                                       class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.hide %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900 text-sm sm:text-base">비공개</div>
                                    <div class="text-xs sm:text-sm text-slate-500">본인만 볼 수 있습니다</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="notice" 
                                       name="notice" 
                                       x-model="form.notice"
                                       class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.notice %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900 text-sm sm:text-base">공지사항으로 고정</div>
                                    <div class="text-xs sm:text-sm text-slate-500">블로그 상단에 고정됩니다</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" 
                                       id="advertise" 
                                       name="advertise" 
                                       x-model="form.advertise"
                                       class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5" 
                                       {% if post.config.advertise %}checked{% endif %}>
                                <div>
                                    <div class="font-medium text-slate-700 group-hover:text-slate-900 text-sm sm:text-base">광고 표시</div>
                                    <div class="text-xs sm:text-sm text-slate-500">이 게시글에 광고를 표시합니다</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    {% if is_edit %}
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 sm:p-6">
                        <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold text-red-700 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            위험 구역
                        </h3>
                        <button type="button" 
                                @click="deletePost"
                                class="w-full flex items-center justify-center gap-2 px-4 py-2 sm:py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            게시글 삭제
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('postEditor', () => ({
            form: {
                title: `{{ post.title|default:"" }}`,
                url: `{{ post.url|default:"" }}`,
                metaDescription: `{{ post.meta_description|default:"" }}`,
                hide: {{ post.config.hide|yesno:"true,false" }},
                notice: {{ post.config.notice|yesno:"true,false" }},
                advertise: {{ post.config.advertise|yesno:"true,false" }}
            },
            tags: `{{ post.tags.all|join:"," }}`.split(',').filter(tag => tag.trim() !== ''),
            newTag: '',
            imagePreview: {% if post.image %}`{{ post.image.url }}`{% else %}null{% endif %},
            selectedSeriesId: `{{ post.series.id|default:"" }}`,
            selectedSeriesName: `{{ post.series.name|default:"" }}`,
            isEdit: {{ is_edit|yesno:"true,false" }},

            init() {
                if (this.selectedSeriesName === '') {
                    this.selectedSeriesName = '시리즈 선택';
                }
            },

            addTag() {
                const tag = this.newTag.trim();
                if (tag && !this.tags.includes(tag)) {
                    this.tags.push(tag);
                    this.newTag = '';
                }
            },

            removeTag(index) {
                this.tags.splice(index, 1);
            },

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            removeImage() {
                this.imagePreview = null;
                document.getElementById('image').value = '';
                
                // 이미지 삭제 플래그 추가
                let removeImageFlag = document.getElementById('remove_image');
                if (!removeImageFlag) {
                    removeImageFlag = document.createElement('input');
                    removeImageFlag.type = 'hidden';
                    removeImageFlag.id = 'remove_image';
                    removeImageFlag.name = 'remove_image';
                    document.getElementById('postForm').appendChild(removeImageFlag);
                }
                removeImageFlag.value = 'true';
            },

            selectSeries(id, name) {
                this.selectedSeriesId = id;
                this.selectedSeriesName = name === '없음' ? '시리즈 선택' : name;
            },

            generateUrlFromTitle() {
                this.form.url = this.form.title
                    .toLowerCase()
                    .replace(/[^a-z0-9가-힣\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .substring(0, 50);
            },

            validateForm() {
                if (!this.form.title.trim()) {
                    alert('제목을 입력해주세요.');
                    return false;
                }
                // URL validation only for new posts
                if (!this.isEdit && !this.form.url.trim()) {
                    alert('URL 주소를 입력해주세요.');
                    return false;
                }
                return true;
            },

            saveDraft() {
                if (this.validateForm()) {
                    this.addFormField('is_draft', 'true');
                    this.submitForm();
                }
            },

            publishPost() {
                if (this.validateForm()) {
                    this.submitForm();
                }
            },

            deletePost() {
                if (confirm('정말로 이 게시글을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    this.addFormField('delete', 'true');
                    this.submitForm();
                }
            },

            addFormField(name, value) {
                let field = document.getElementById(name);
                if (!field) {
                    field = document.createElement('input');
                    field.type = 'hidden';
                    field.id = name;
                    field.name = name;
                    document.getElementById('postForm').appendChild(field);
                }
                field.value = value;
            },

            submitForm() {
                document.getElementById('postForm').submit();
            }
        }));
    });
</script>
{% endblock %}
