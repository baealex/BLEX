{% extends 'board/base.html' %}
{% load resource %}
{% load island %}

{% block title %}{{ post.title }} - {{ post.author_username }} | BLEX{% endblock %}

{% block meta %}
<!-- Primary Meta Tags -->
<meta name="description" content="{{ post.meta_description }}">
<meta name="keywords" content="{% for tag in post.tags.all %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}">
<meta name="author" content="{{ post.author_username }}">
<!-- Robots and Indexing -->
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.meta_description }}">
{% if post.image %}<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}">{% endif %}
<meta property="article:published_time" content="{{ post.created_at|date:'c' }}">
<meta property="article:modified_time" content="{{ post.updated_at|date:'c' }}">
<meta property="article:author" content="{{ request.scheme }}://{{ request.get_host }}/@{{ post.author_username }}">
{% for tag in post.tags.all %}<meta property="article:tag" content="{{ tag }}">{% endfor %}

<!-- Twitter -->
<meta property="twitter:card" content="{% if post.image %}summary_large_image{% else %}summary{% endif %}">
<meta property="twitter:url" content="{{ request.build_absolute_uri }}">
<meta property="twitter:title" content="{{ post.title }}">
<meta property="twitter:description" content="{{ post.meta_description }}">
{% if post.image %}<meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}">{% endif %}

<!-- Canonical URL -->
<link rel="canonical" href="{{ request.build_absolute_uri }}">
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% island_css 'styles/post.scss' %}">
{% endblock %}

{% block content %}
<div class="max-w-4xl w-full mx-auto sm:py-8" role="main">
    <article itemscope itemtype="https://schema.org/BlogPosting" lang="{{ LANGUAGE_CODE|default:'ko' }}">
        <meta itemprop="headline" content="{{ post.title }}">
        <meta itemprop="description" content="{{ post.meta_description }}">
        <meta itemprop="datePublished" content="{{ post.created_date|date:'c' }}">
        <meta itemprop="dateModified" content="{{ post.updated_date|date:'c' }}">
        {% if post.image %}
        <meta itemprop="image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}">
        {% endif %}
        
        <!-- 포스트 헤더 -->
        <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 shadow-sm">
            <!-- 포스트 제목과 메타 정보 -->
            <div class="flex items-center gap-2 mb-4">
                <div class="w-3 h-3 bg-black rounded-full"></div>
                <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Article</span>
            </div>
            
            <h1 class="text-2xl sm:text-3xl lg:text-5xl font-bold text-gray-900 mb-4 sm:mb-6 leading-tight break-words" itemprop="headline">
                {{ post.title }}
            </h1>
            
            <!-- 포스트 메타 정보 -->
            <div class="flex flex-wrap items-center gap-4 sm:gap-6 text-sm text-gray-600 mb-6 sm:mb-8">
                <div class="flex items-center gap-2" itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <a href="/@{{ post.author_username }}">
                        <img class="w-8 h-8 rounded-full object-cover" 
                             src="{% media post.author_image %}"
                             alt="{{ post.author_username }}">
                    </a>
                    <a href="/@{{ post.author_username }}" class="font-semibold text-gray-900 hover:text-black transition-colors" itemprop="name">
                        {{ post.author_username }}
                    </a>
                </div>
                
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar text-gray-400"></i>
                    <span itemprop="datePublished" content="{{ post.created_date|date:'c' }}">{{ post.created_date }}</span>
                </div>
                
                <div class="flex items-center gap-2" aria-label="읽는 데 걸리는 시간">
                    <i class="far fa-clock text-gray-400"></i>
                    <span>{{ post.read_time }}분</span>
                </div>
            </div>
            
            
            <!-- 커버 이미지 -->
            {% if post.image %}
            <div class="mt-0">
                <img class="w-full rounded-2xl shadow-sm" src="{{ post.image.url }}" alt="{{ post.title }}" itemprop="image">
            </div>
            {% endif %}
        </div>
        
        <!-- 본문 콘텐츠 -->
        <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 shadow-sm">
            <div class="prose prose-sm sm:prose-lg max-w-none blog-post-content break-words" itemprop="articleBody" lang="{{ LANGUAGE_CODE|default:'ko' }}">
                {{ post.content.text_html|safe }}
            </div>

            <!-- 태그 -->
            {% if post.tags %}
            <div class="mt-6 sm:mt-8 pt-6 sm:pt-8 border-t border-gray-200" itemprop="keywords">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-6 h-6 bg-gray-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-hashtag text-gray-900 text-xs"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-900">태그</h3>
                </div>
                <div class="flex flex-wrap gap-2">
                    {% for tag in post.tags.all %}
                        <a href="{% url 'tag_detail' tag %}" class="inline-flex items-center px-4 py-2 bg-gray-50 hover:bg-black hover:text-white text-gray-700 rounded-xl text-sm font-medium transition-all duration-200 break-all border border-gray-200 hover:border-black">
                            <i class="fas fa-hashtag text-xs mr-1.5 flex-shrink-0"></i>{{ tag }}
                        </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </article>

    <!-- 스티키 액션 바 (Alpine.js 사용) -->
    <div x-data="{ 
        shareMessage: '공유',
        showFeedback: false,
        async copyToClipboard() {
            try {
                const decodedUrl = decodeURIComponent(window.location.href);
                await navigator.clipboard.writeText(decodedUrl);
                this.shareMessage = '링크 복사됨!';
                this.showFeedback = true;
                
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                
                setTimeout(() => {
                    this.shareMessage = '공유';
                    this.showFeedback = false;
                }, 2000);
            } catch (error) {
                this.shareMessage = '복사 실패';
                setTimeout(() => this.shareMessage = '공유', 2000);
            }
        }
    }" class="sticky bottom-0 left-0 right-0 z-40 mb-6 sm:mb-8">
        <div class="max-w-4xl w-full mx-auto px-2 sm:px-4 py-3 bg-white shadow-sm rounded-2xl">
            <div class="flex items-center justify-between">
                <!-- 왼쪽: 포스트 정보 -->
                <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                    <div class="flex items-center gap-2 min-w-0">
                        <a href="/@{{ post.author_username }}">
                            <img class="w-8 h-8 rounded-full object-cover flex-shrink-0" 
                                src="{% media post.author_image %}" 
                                alt="{{ post.author_username }}">
                        </a>
                        <div class="min-w-0 hidden sm:block">
                            <div class="font-semibold text-gray-900 truncate">{{ post.title }}</div>
                            <div class="text-xs text-gray-500">by {{ post.author_username }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- 오른쪽: 액션 버튼들 -->
                <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                    {% include 'components/like_button.html' with post_url=post.url likes_count=post.count_likes has_liked=post.has_liked size='small' %}
                    
                    <button @click="
                        if (navigator.share) {
                            const decodedUrl = decodeURIComponent(window.location.href);
                            navigator.share({
                                title: '{{ post.title }}',
                                text: '{{ post.meta_description }}',
                                url: decodedUrl
                            }).catch(error => {
                                console.log('Error sharing:', error);
                                copyToClipboard();
                            });
                        } else {
                            copyToClipboard();
                        }
                    "
                    class="flex items-center gap-1 sm:gap-2 px-3 py-2.5 sm:px-3 sm:py-2 transition-all duration-200 text-sm rounded-xl font-medium min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto"
                    :class="showFeedback ? 'bg-gray-100 text-gray-900 transform scale-95' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 hover:scale-105 active:scale-95'"
                    aria-label="게시물 공유하기">
                        <i class="fas fa-share-alt" :class="showFeedback ? 'text-gray-900' : ''"></i>
                        <span x-text="shareMessage"></span>
                        <span class="text-xs" x-show="showFeedback" x-transition>✓</span>
                    </button>

                    {% if user.is_authenticated and user.username == post.author_username %}
                    <a href="{% url 'post_edit' post.author_username post.url %}" class="flex items-center gap-1 sm:gap-2 px-3 py-2.5 sm:px-3 sm:py-2 bg-black hover:bg-gray-800 text-white rounded-xl font-medium transition-all duration-200 text-sm min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto shadow-md">
                        <i class="fas fa-edit"></i>
                        <span>편집</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 시리즈 정보 -->
    {% if post.series %}
    <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6 lg:p-8 mb-8 shadow-sm">
        <div class="flex flex-col lg:flex-row lg:items-start gap-6">
            <!-- 시리즈 제목과 진행률 -->
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-3 h-3 bg-black rounded-full"></div>
                    <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Series</span>
                </div>

                <h3 class="text-2xl font-bold text-gray-900 mb-4">
                    <a href="{% url 'series_detail' post.author_username post.series.url %}" class="hover:text-black transition-colors">
                        {{ post.series.name }}
                    </a>
                </h3>
                
                <div class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                    {{ post.series_index }} / {{ post.series_total }} 포스트
                </div>
            </div>
        </div>
        
        <!-- 시리즈 포스트 목록 -->
        <div class="mt-8 border-t border-gray-200 pt-6">
            <h4 class="font-semibold text-gray-900 mb-4">시리즈 목록</h4>
            <div class="space-y-3">
                {% for series_post in post.visible_series_posts %}
                <div class="flex items-center gap-3 p-4 {% if series_post.url == post.url %}bg-gray-100 border-2 border-gray-300{% else %}bg-gray-50 border border-gray-200{% endif %} rounded-xl transition-all duration-200">
                    <div class="w-8 h-8 {% if series_post.url == post.url %}bg-black text-white{% else %}bg-gray-200 text-gray-600{% endif %} rounded-2xl flex items-center justify-center text-sm font-bold flex-shrink-0">
                        {{ series_post.series_index }}
                    </div>
                    {% if series_post.url == post.url %}
                    <span class="flex-1 font-semibold text-black">{{ series_post.title }}</span>
                    <span class="text-xs flex items-center gap-1 text-black font-medium"><i class="fas fa-check"></i><span>읽는 중</span></span>
                    {% else %}
                    <a href="{% url 'post_detail' post.author_username series_post.url %}" class="flex-1 font-medium text-gray-700 hover:text-black transition-colors">
                        {{ series_post.title }}
                    </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- 네비게이션 버튼들 -->
        {% if post.series_total > 1 %}
        <div class="mt-6 sm:mt-8 flex-shrink-0">
            <div class="flex flex-col sm:flex-row sm:justify-center gap-3">
                {% if post.prev_post %}
                <a href="{% url 'post_detail' post.author_username post.prev_post.url %}" class="flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-all duration-200 text-sm sm:text-base shadow-sm hover:shadow-md">
                    <i class="fas fa-chevron-left"></i>
                    <span>이전 포스트</span>
                </a>
                {% else %}
                <div class="flex items-center justify-center gap-2 px-6 py-3 bg-gray-50 text-gray-400 rounded-xl font-medium cursor-not-allowed text-sm sm:text-base">
                    <i class="fas fa-chevron-left"></i>
                    <span>이전 포스트</span>
                </div>
                {% endif %}

                <a href="{% url 'series_detail' post.author_username post.series.url %}" class="flex items-center justify-center gap-2 px-6 py-3 bg-black hover:bg-gray-800 text-white rounded-xl font-medium transition-all duration-200 text-sm sm:text-base shadow-md hover:shadow-lg">
                    <i class="fas fa-th-list"></i>
                    <span>전체 시리즈</span>
                </a>

                {% if post.next_post %}
                <a href="{% url 'post_detail' post.author_username post.next_post.url %}" class="flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-all duration-200 text-sm sm:text-base shadow-sm hover:shadow-md">
                    <span>다음 포스트</span>
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <div class="flex items-center justify-center gap-2 px-6 py-3 bg-gray-50 text-gray-400 rounded-xl font-medium cursor-not-allowed text-sm sm:text-base">
                    <span>다음 포스트</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 댓글 섹션 -->
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm mb-8">
        <div class="p-4 sm:p-6 lg:p-8">
            {% island_component 'Comments' lazy=True postUrl=post.url %}
        </div>
    </div>

    <!-- 관련 포스트 -->
    {% island_component 'RelatedPosts' lazy=True postUrl=post.url username=post.author_username %}
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Structured Data for Articles (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  },
  "headline": "{{ post.title }}",
  "description": "{{ post.meta_description }}",
  "image": {% if post.image %}"{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}"{% else %}null{% endif %},
  "author": {
    "@type": "Person",
    "name": "{{ post.author_username }}",
    "url": "{{ request.scheme }}://{{ request.get_host }}/@{{ post.author_username }}"{% if post.author.profile.homepage or post.author.userlinkmeta_set.all %},
    "sameAs": [
      {% if post.author.profile.homepage %}"{{ post.author.profile.homepage }}"{% if post.author.userlinkmeta_set.all %},{% endif %}{% endif %}{% for link in post.author.userlinkmeta_set.all %}
      "{{ link.value }}"{% if not forloop.last %},{% endif %}{% endfor %}
    ]{% endif %}
  },
  "publisher": {
    "@type": "Organization",
    "name": "BLEX",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ request.scheme }}://{{ request.get_host }}{% resource 'logo.png' %}"
    }
  },
  "datePublished": "{{ post.created_date|date:'c' }}",
  "dateModified": "{{ post.updated_date|date:'c' }}",
  {% if post.tags.all %}"keywords": "{% for tag in post.tags.all %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}",{% endif %}
  "articleSection": {% if post.series %}"{{ post.series.name }}"{% else %}"Blog"{% endif %},
  "wordCount": "{{ post.read_time|default:5|stringformat:'i' }}00"
}
</script>
<script type="module" src="{% island_entry 'src/scripts/syntax-highlighting.ts' %}"></script>

{% endblock %}
